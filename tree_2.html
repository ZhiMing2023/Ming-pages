<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ„ æ˜Ÿæ˜Ÿåœ£è¯æ ‘ Â· æ‰‹åŠ¿äº’åŠ¨</title>
  <style>
    :root{--bg:#060a18;--fg:rgba(255,255,255,.92);--muted:rgba(255,255,255,.65)}
    *{box-sizing:border-box}
    body{
      margin:0;min-height:100vh;display:grid;place-items:center;
      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(124,58,237,.22), transparent 55%),
        radial-gradient(900px 600px at 75% 35%, rgba(34,197,94,.14), transparent 55%),
        linear-gradient(180deg, #050714, var(--bg));
      color:var(--fg);
      font-family: system-ui,-apple-system,"PingFang SC","Microsoft YaHei",Arial;
      overflow:hidden;
    }
    .wrap{
      width:min(980px, 96vw);
      padding:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      border-radius:18px;
      box-shadow:0 18px 60px rgba(0,0,0,.45);
    }
    h1{margin:0 0 6px 0;font-size:18px}
    .sub{font-size:12px;color:var(--muted);line-height:1.6;margin-bottom:10px}
    .grid{display:grid;grid-template-columns: 1fr;gap:10px}
    canvas{
      width:100%;
      height:auto;
      aspect-ratio: 16/10;
      border-radius:16px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    button{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.10);
      color:var(--fg);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:650;
    }
    button:hover{transform:translateY(-1px)}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      font-size:12px;color:var(--muted);
    }
    video{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ„ æ˜Ÿæ˜Ÿå¡«å……åœ£è¯æ ‘ Â· æ‘„åƒå¤´æ‰‹åŠ¿äº’åŠ¨</h1>
    <div class="sub">
      å…è®¸æ‘„åƒå¤´åï¼š<b>é£ŸæŒ‡æŒ‡å°–</b>ç§»åŠ¨ â†’ æ˜Ÿæ˜Ÿè·Ÿéšï¼›<b>æ‹‡æŒ‡+é£ŸæŒ‡æåˆ</b> â†’ æ˜Ÿæ˜Ÿèšæ‹¢/æ•£å¼€ã€‚<br/>
      ï¼ˆéœ€è¦ HTTPS æ‰æ›´ç¨³å®šï¼šGitHub Pages æœ€åˆé€‚ï¼‰
    </div>

    <div class="grid">
      <canvas id="view" width="960" height="600"></canvas>
      <div class="row">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button id="start">å¼€å¯æ‘„åƒå¤´</button>
          <button id="toggleCam">æ˜¾ç¤º/éšè—æ‘„åƒå¤´èƒŒæ™¯</button>
          <button id="reset">å›æ­£</button>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <span class="pill">Pinchï¼š<b id="pinch">â€”</b></span>
          <span class="pill">æ‰‹ï¼š<b id="hand">æœªæ£€æµ‹</b></span>
          <span class="pill">æ˜Ÿæ˜Ÿæ•°ï¼š<b id="n">0</b></span>
        </div>
      </div>
    </div>

    <video id="video" playsinline></video>
  </div>

  <!-- MediaPipe Hands (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
(() => {
  const canvas = document.getElementById('view');
  const ctx = canvas.getContext('2d');
  const video = document.getElementById('video');

  const startBtn = document.getElementById('start');
  const toggleCamBtn = document.getElementById('toggleCam');
  const resetBtn = document.getElementById('reset');

  const pinchEl = document.getElementById('pinch');
  const handEl = document.getElementById('hand');
  const nEl = document.getElementById('n');

  let showCamera = false;
  toggleCamBtn.onclick = () => showCamera = !showCamera;

  // ===== Tree mask parameters =====
  // Tree in normalized canvas space [0..1]
  const TREE = {
    cx: 0.52,
    top: 0.12,
    bottom: 0.86,
    halfWidthAtBottom: 0.26,   // tree base half width
    trunkW: 0.06,
    trunkH: 0.12
  };

  // ===== Stars =====
  const STAR_COUNT = 1100; // å¤šä¸€ç‚¹æ›´â€œå¡«å……â€
  const stars = [];
  let basePoints = []; // åˆå§‹æ ‘å†…ç‚¹äº‘

  function rand(min, max){ return min + Math.random()*(max-min); }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  // åˆ¤æ–­ç‚¹æ˜¯å¦åœ¨â€œæ ‘å½¢åŒºåŸŸâ€å†…ï¼ˆç®€åŒ–ä¸ºï¼šä¸‰è§’å½¢æ ‘ + çŸ©å½¢æ ‘å¹²ï¼‰
  function insideTree(u, v){
    // tree triangle
    const {cx, top, bottom, halfWidthAtBottom} = TREE;
    if (v < top || v > bottom) return false;

    const t = (v - top) / (bottom - top);           // 0(top) -> 1(bottom)
    const halfW = halfWidthAtBottom * t;            // çº¿æ€§å±•å¼€
    const left = cx - halfW;
    const right = cx + halfW;

    const inTri = (u >= left && u <= right);

    // trunk
    const trunkTop = bottom;
    const trunkBottom = bottom + TREE.trunkH;
    const trunkLeft = cx - TREE.trunkW/2;
    const trunkRight = cx + TREE.trunkW/2;
    const inTrunk = (v >= trunkTop && v <= trunkBottom && u >= trunkLeft && u <= trunkRight);

    return inTri || inTrunk;
  }

  // åœ¨æ ‘å½¢åŒºåŸŸå†…é‡‡æ ·ç‚¹
  function sampleTreePoints(count){
    const pts = [];
    let guard = 0;
    while (pts.length < count && guard < count*80){
      guard++;
      const u = Math.random();
      const v = Math.random();
      if (insideTree(u,v)){
        pts.push({u, v});
      }
    }
    return pts;
  }

  // ç”»æ˜Ÿæ˜Ÿï¼ˆç®€å•äº”è§’æ˜Ÿï¼‰
  function drawStar(x, y, r, rot){
    ctx.save();
    ctx.translate(x,y);
    ctx.rotate(rot);
    ctx.beginPath();
    const spikes = 5;
    const outer = r;
    const inner = r * 0.45;
    let ang = -Math.PI/2;
    const step = Math.PI / spikes;
    ctx.moveTo(Math.cos(ang)*outer, Math.sin(ang)*outer);
    for(let i=0;i<spikes;i++){
      ctx.lineTo(Math.cos(ang)*outer, Math.sin(ang)*outer);
      ang += step;
      ctx.lineTo(Math.cos(ang)*inner, Math.sin(ang)*inner);
      ang += step;
    }
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  // åˆå§‹åŒ–æ˜Ÿæ˜Ÿï¼šæŠŠç‚¹äº‘æ˜ å°„åˆ° stars
  function initStars(){
    basePoints = sampleTreePoints(STAR_COUNT);
    stars.length = 0;
    for (let i=0;i<STAR_COUNT;i++){
      const p = basePoints[i];
      stars.push({
        // base position in normalized space
        u: p.u, v: p.v,
        // dynamics
        x: p.u, y: p.v,
        vx: 0, vy: 0,
        // style
        r: rand(1.2, 2.8),
        rot: rand(0, Math.PI*2),
        tw: rand(0.2, 1.0),
        hue: rand(40, 60) // é‡‘é»„
      });
    }
    nEl.textContent = String(STAR_COUNT);
  }

  // ===== Hand control state =====
  // handPos: [0..1] ç”»å¸ƒç©ºé—´ï¼Œpinch: [0..1]
  let handX = 0.52, handY = 0.45;
  let haveHand = false;

  // pinchRaw: thumb-index distance in normalized image; convert to pinchStrength
  let pinchStrength = 0.0; // 0(å¼ å¼€/æ•£) -> 1(æåˆ/èš)

  function resetControl(){
    handX = 0.52; handY = 0.45;
    pinchStrength = 0.0;
  }
  resetBtn.onclick = resetControl;

  // ===== Physics: æ˜Ÿæ˜Ÿè·Ÿæ‰‹åŠ¿â€œèšæ‹¢/æ•£å¼€/è·Ÿéšâ€ =====
  // æ€è·¯ï¼š
  // - æ¯ä¸ªæ˜Ÿæ˜Ÿæœ‰ä¸€ä¸ªâ€œæ ‘å†…åŸºå‡†ä½ç½® base(u,v)â€
  // - æ ¹æ® pinchStrengthï¼š
  //   - è¶Šæåˆï¼šè¶Šå‘ handPos èšæ‹¢ï¼ˆå¸é™„å¼ºï¼‰
  //   - è¶Šå¼ å¼€ï¼šæ›´é è¿‘ baseï¼ˆå›åˆ°æ ‘å½¢å¡«å……ï¼‰
  // - åŒæ—¶åŠ ä¸€ç‚¹â€œæ¶Ÿæ¼ª/æŠ–åŠ¨â€ï¼Œæ›´åƒæ´»çš„æ˜Ÿæ˜Ÿ
  function step(dt){
    // åŠ¨åŠ›å‚æ•°
    const attract = 18 + pinchStrength * 55;      // å¸å¼•å¼ºåº¦
    const returnK = 26 * (1 - pinchStrength);    // å›å½’åŸºå‡†
    const damp = 0.86;

    for (let i=0;i<stars.length;i++){
      const s = stars[i];

      // ç›®æ ‡ç‚¹ï¼šåœ¨ base å’Œ handPos ä¹‹é—´æ’å€¼
      const tx = s.u*(1 - pinchStrength) + handX*pinchStrength;
      const ty = s.v*(1 - pinchStrength) + handY*pinchStrength;

      // åŠ›ï¼šæœç›®æ ‡ç‚¹
      const dx = tx - s.x;
      const dy = ty - s.y;

      // é¢å¤–ï¼šå¼ å¼€æ—¶æ›´â€œå›æ ‘é‡Œâ€
      const rx = (s.u - s.x) * returnK;
      const ry = (s.v - s.y) * returnK;

      s.vx = (s.vx + dx*attract + rx) * damp;
      s.vy = (s.vy + dy*attract + ry) * damp;

      // è½»å¾®æ¼‚æµ®ï¼ˆæ›´æ¢¦å¹»ï¼‰
      const jig = (0.0018 + 0.0025*(1-pinchStrength));
      s.vx += (Math.sin((i*0.7 + performance.now()*0.003)))*jig;
      s.vy += (Math.cos((i*0.9 + performance.now()*0.0027)))*jig;

      s.x += s.vx * dt;
      s.y += s.vy * dt;

      // é™åˆ¶åœ¨ç”»å¸ƒèŒƒå›´ï¼ˆé¿å…é£å‡ºï¼‰
      s.x = clamp(s.x, 0.02, 0.98);
      s.y = clamp(s.y, 0.02, 0.98);

      // æ˜Ÿæ˜Ÿè‡ªè½¬
      s.rot += (0.6 + pinchStrength*1.2) * dt * 0.03;
    }
  }

  function draw(){
    const w = canvas.width, h = canvas.height;
    // èƒŒæ™¯
    ctx.clearRect(0,0,w,h);

    if (showCamera && video.readyState >= 2){
      // æ‘„åƒå¤´èƒŒæ™¯ï¼ˆè½»å¾®å˜æš—ï¼‰
      ctx.save();
      ctx.globalAlpha = 0.35;
      // é•œåƒæ˜¾ç¤ºæ›´ç›´è§‚
      ctx.translate(w,0);
      ctx.scale(-1,1);
      ctx.drawImage(video, 0,0,w,h);
      ctx.restore();
    }

    // æŸ”å’ŒèƒŒæ™¯é›¾
    ctx.save();
    const g = ctx.createRadialGradient(w*0.2, h*0.15, 10, w*0.2, h*0.15, w*0.9);
    g.addColorStop(0, "rgba(124,58,237,0.18)");
    g.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);
    ctx.restore();

    // å…ˆç”»æ ‘è½®å»“ï¼ˆæ·¡æ·¡çš„ï¼‰
    drawTreeSilhouette(w,h);

    // ç”»æ˜Ÿæ˜Ÿï¼ˆä½œä¸ºæ ‘çš„â€œå¡«å……â€ï¼‰
    for (const s of stars){
      // ä»…æ¸²æŸ“æ ‘åŒºåŸŸé™„è¿‘ï¼ˆæå‡â€œæ ‘å½¢æ„Ÿâ€ï¼‰
      // pinch æ—¶å…è®¸ç¦»å¼€æ ‘ä¸€ç‚¹ç‚¹
      const inTreeNow = insideTree(s.x, s.y) || pinchStrength > 0.35;
      if (!inTreeNow) continue;

      const x = s.x * w;
      const y = s.y * h;

      // é—ªçƒ
      const tw = 0.65 + 0.35*Math.sin(performance.now()*0.006 + s.tw*10);
      ctx.fillStyle = `hsla(${s.hue} 95% 65% / ${0.55 + 0.35*tw})`;
      drawStar(x, y, s.r * (0.85 + 0.45*tw), s.rot);
    }

    // é¡¶éƒ¨å¤§æ˜Ÿæ˜Ÿ
    drawTopStar(w,h);

    // æ‰‹çš„è°ƒè¯•ç‚¹ï¼ˆå¯å…³ï¼‰
    if (haveHand){
      ctx.save();
      ctx.globalAlpha = 0.9;
      ctx.fillStyle = "rgba(34,197,94,0.9)";
      ctx.beginPath();
      ctx.arc(handX*w, handY*h, 6, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }
  }

  function drawTreeSilhouette(w,h){
    const {cx, top, bottom, halfWidthAtBottom} = TREE;
    ctx.save();
    ctx.fillStyle = "rgba(34,197,94,0.10)";
    ctx.strokeStyle = "rgba(255,255,255,0.12)";
    ctx.lineWidth = 2;

    ctx.beginPath();
    ctx.moveTo((cx)*w, top*h);
    ctx.lineTo((cx - halfWidthAtBottom)*w, bottom*h);
    ctx.lineTo((cx + halfWidthAtBottom)*w, bottom*h);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    // trunk
    ctx.fillStyle = "rgba(161,98,7,0.18)";
    const trunkX = (cx - TREE.trunkW/2)*w;
    const trunkY = bottom*h;
    ctx.fillRect(trunkX, trunkY, TREE.trunkW*w, TREE.trunkH*h);

    // åœ°é¢
    ctx.fillStyle = "rgba(255,255,255,0.06)";
    ctx.beginPath();
    ctx.ellipse(w*0.52, h*0.89, w*0.42, h*0.10, 0, 0, Math.PI*2);
    ctx.fill();

    ctx.restore();
  }

  function drawTopStar(w,h){
    const x = TREE.cx*w;
    const y = (TREE.top*h) - 18;
    ctx.save();
    ctx.fillStyle = "rgba(250,204,21,0.95)";
    drawStar(x, y, 14, performance.now()*0.0012);
    ctx.fillStyle = "rgba(250,204,21,0.18)";
    ctx.beginPath();
    ctx.arc(x,y, 34, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  // ===== Main loop =====
  let lastT = performance.now();
  function loop(t){
    const dt = Math.min(0.033, (t-lastT)/1000);
    lastT = t;
    step(dt);
    draw();
    requestAnimationFrame(loop);
  }

  // ===== MediaPipe Hands setup =====
  let hands, camera;

  function dist(a,b){
    const dx = a.x - b.x, dy = a.y - b.y;
    return Math.sqrt(dx*dx + dy*dy);
  }

  function setupHands(){
    hands = new Hands({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });
    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.6,
      minTrackingConfidence: 0.6
    });

    hands.onResults((res) => {
      if (!res.multiHandLandmarks || res.multiHandLandmarks.length === 0){
        haveHand = false;
        handEl.textContent = "æœªæ£€æµ‹";
        pinchEl.textContent = "â€”";
        return;
      }

      haveHand = true;
      handEl.textContent = "å·²æ£€æµ‹";

      const lm = res.multiHandLandmarks[0];

      // æŒ‡å°–ï¼š8ï¼ˆé£ŸæŒ‡æŒ‡å°–ï¼‰ï¼Œæåˆï¼š4ï¼ˆæ‹‡æŒ‡æŒ‡å°–ï¼‰å’Œ 8ï¼ˆé£ŸæŒ‡æŒ‡å°–ï¼‰
      const indexTip = lm[8];
      const thumbTip = lm[4];

      // MediaPipe æ˜¯ä»¥è§†é¢‘ä¸ºåŸºå‡†çš„åæ ‡ï¼ˆ0..1ï¼‰ã€‚æˆ‘ä»¬é•œåƒæ˜¾ç¤ºè§†é¢‘ï¼Œå› æ­¤æ‰‹çš„ x ä¹Ÿé•œåƒä¸€ä¸‹æ›´ç¬¦åˆç›´è§‰ã€‚
      const hx = 1 - indexTip.x;
      const hy = indexTip.y;

      // å¹³æ»‘ä¸€ç‚¹
      handX = handX*0.75 + hx*0.25;
      handY = handY*0.75 + hy*0.25;

      // pinch è·ç¦»ï¼šè¶Šå°è¶Šâ€œæåˆâ€
      const d = dist(indexTip, thumbTip); // é€šå¸¸ 0.02~0.25 ä¹‹é—´
      // æ˜ å°„åˆ° 0..1ï¼šdå° => 1ï¼›då¤§ => 0
      const p = 1 - clamp((d - 0.03) / 0.18, 0, 1);
      pinchStrength = pinchStrength*0.7 + p*0.3;

      pinchEl.textContent = pinchStrength.toFixed(2);
    });
  }

  async function startCamera(){
    setupHands();

    // ç”¨ CameraUtils é©±åŠ¨ï¼šä¼šè‡ªåŠ¨æŠŠ video å¸§é€å…¥ hands
    camera = new Camera(video, {
      onFrame: async () => {
        await hands.send({image: video});
      },
      width: 960,
      height: 600
    });
    await camera.start();
  }

  startBtn.onclick = async () => {
    try{
      startBtn.disabled = true;
      startBtn.textContent = "å¯åŠ¨ä¸­â€¦";
      await startCamera();
      startBtn.textContent = "æ‘„åƒå¤´å·²å¼€å¯ âœ…";
    }catch(e){
      console.error(e);
      startBtn.disabled = false;
      startBtn.textContent = "å¼€å¯æ‘„åƒå¤´";
      alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼šè¯·ç¡®è®¤åœ¨ HTTPS é¡µé¢æ‰“å¼€ï¼Œå¹¶å…è®¸æ‘„åƒå¤´æƒé™ã€‚");
    }
  };

  // ===== Init =====
  initStars();
  resetControl();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
