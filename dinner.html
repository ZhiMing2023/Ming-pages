<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ™šé¥­éšæœºå¤§è½¬ç›˜</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: rgba(255,255,255,0.08);
      --panel2: rgba(255,255,255,0.12);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --accent: #7c3aed;
      --accent2: #22c55e;
      --danger: #ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(124,58,237,.35), transparent 55%),
                  radial-gradient(900px 700px at 80% 40%, rgba(34,197,94,.25), transparent 55%),
                  linear-gradient(180deg, #070a14, var(--bg));
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", "Noto Sans CJK SC", Arial;
    }
    .app{
      width:min(980px, 96vw);
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width: 860px){
      .app{grid-template-columns:1fr; width:min(680px, 96vw)}
    }
    .card{
      background: linear-gradient(180deg, var(--panel), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.45);
      overflow:hidden;
    }
    h1{
      font-size:18px;
      margin:0 0 10px 0;
      font-weight:700;
      letter-spacing:.5px;
    }
    .sub{
      font-size:12px;
      color:var(--muted);
      margin-bottom:10px;
      line-height:1.5;
    }
    .wheelWrap{
      display:grid;
      place-items:center;
      gap:12px;
    }
    canvas{
      width:min(420px, 86vw);
      height:auto;
      aspect-ratio:1/1;
      background: rgba(255,255,255,0.03);
      border-radius: 999px;
      border:1px solid rgba(255,255,255,0.10);
      box-shadow: inset 0 0 0 10px rgba(0,0,0,0.18), 0 10px 40px rgba(0,0,0,0.35);
    }
    .pointer{
      width:0;height:0;
      border-left:14px solid transparent;
      border-right:14px solid transparent;
      border-bottom:22px solid rgba(255,255,255,0.9);
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.4));
      margin-top:2px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center}
    button{
      border:0;
      border-radius: 14px;
      padding: 10px 12px;
      color: var(--text);
      background: rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.14);
      cursor:pointer;
      transition: .15s ease;
      font-weight:650;
    }
    button:hover{transform: translateY(-1px); background: rgba(255,255,255,0.14)}
    button:active{transform: translateY(0px)}
    button.primary{
      background: linear-gradient(135deg, rgba(124,58,237,0.95), rgba(124,58,237,0.55));
      border: 1px solid rgba(124,58,237,0.55);
    }
    button.primary:hover{background: linear-gradient(135deg, rgba(124,58,237,1), rgba(124,58,237,0.65))}
    button.green{
      background: linear-gradient(135deg, rgba(34,197,94,0.95), rgba(34,197,94,0.55));
      border: 1px solid rgba(34,197,94,0.55);
    }
    button.danger{
      background: rgba(239,68,68,0.14);
      border:1px solid rgba(239,68,68,0.35);
    }
    button:disabled{
      opacity:.55; cursor:not-allowed; transform:none;
    }
    .editor{
      display:grid;
      grid-template-rows:auto 1fr auto;
      gap:10px;
      height:100%;
    }
    textarea{
      width:100%;
      resize:vertical;
      min-height: 220px;
      border-radius: 16px;
      padding: 12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      outline:none;
      line-height:1.5;
    }
    .small{
      font-size:12px;
      color: var(--muted);
      line-height:1.5;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.12);
      font-size:12px;
      color:var(--muted);
    }
    .result{
      margin-top:6px;
      font-size:14px;
      color: var(--muted);
      text-align:center;
      min-height: 20px;
    }
    .toast{
      position: fixed;
      inset:auto 14px 14px auto;
      background: rgba(0,0,0,0.7);
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 13px;
      opacity: 0;
      transform: translateY(10px);
      transition: .2s ease;
      pointer-events:none;
    }
    .toast.show{
      opacity: 1;
      transform: translateY(0);
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      background: rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.85);
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>ğŸœ æ™šé¥­éšæœºå¤§è½¬ç›˜</h1>
      <div class="sub">
        ç‚¹å‡»â€œå¼€å§‹è½¬â€éšæœºæŠ½ä¸€ä¸ªä»Šæ™šåƒä»€ä¹ˆã€‚å³ä¾§å¯ç¼–è¾‘èœå•ï¼›æ”¯æŒä¿å­˜åˆ°æœ¬åœ°ã€‚<br/>
        å¿«æ·é”®ï¼š<span class="kbd">Space</span> å¼€å§‹è½¬ / <span class="kbd">Ctrl</span>+<span class="kbd">S</span> ä¿å­˜èœå•
      </div>

      <div class="wheelWrap">
        <div class="pointer" title="æŒ‡é’ˆ"></div>
        <canvas id="wheel" width="800" height="800"></canvas>

        <div class="row">
          <button class="primary" id="spinBtn">å¼€å§‹è½¬ ğŸ¯</button>
          <button id="shuffleBtn">æ‰“ä¹±é¡ºåº ğŸ”€</button>
          <button class="green" id="pickNowBtn">ä¸è½¬äº†ç›´æ¥æŠ½ âœ…</button>
        </div>

        <div class="row">
          <span class="pill">å€™é€‰ï¼š<b id="count">0</b></span>
          <span class="pill">ç»“æœï¼š<b id="last">â€”</b></span>
        </div>

        <div class="result" id="hint"></div>
      </div>
    </div>

    <div class="card editor">
      <div>
        <h1>âœï¸ èœå•ç¼–è¾‘</h1>
        <div class="small">
          æ¯è¡Œä¸€ä¸ªé€‰é¡¹ï¼ˆå¯å†™â€œç‰›è‚‰é¢â€â€œå¯¿å¸â€â€œå¤–å–éšä¾¿â€è¿™ç§ï¼‰ã€‚ç©ºè¡Œä¼šå¿½ç•¥ã€‚<br/>
          å°æŠ€å·§ï¼šæŠŠâ€œä¸æƒ³åƒâ€å†™è¿›æ¥ä¹Ÿè¡Œï¼ŒæŠ½åˆ°äº†å°±å½“ç³»ç»Ÿæç¤ºä½ åˆ«ç‚¹å®ƒğŸ™‚
        </div>
      </div>

      <textarea id="itemsArea" spellcheck="false"></textarea>

      <div class="row" style="justify-content:space-between">
        <div class="row" style="justify-content:flex-start">
          <button id="saveBtn">ä¿å­˜èœå• ğŸ’¾</button>
          <button class="danger" id="resetBtn" title="æ¢å¤é»˜è®¤èœå•">æ¢å¤é»˜è®¤ â†©</button>
        </div>
        <div class="small">ä¿å­˜ä»…åœ¨å½“å‰æµè§ˆå™¨æœ¬åœ°ç”Ÿæ•ˆï¼ˆlocalStorageï¼‰ã€‚</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  // ====== é»˜è®¤èœå•ï¼ˆå¯æ”¹ï¼‰ ======
  const DEFAULT_ITEMS = [
    "æ‹‰é¢/ä¹Œå†¬",
    "å¯¿å¸/åˆºèº«",
    "å’–å–±é¥­",
    "ç‰›è‚‰é¥­",
    "ç‚¸é¸¡/å”æ‰¬",
    "ç«é”…",
    "çƒ¤è‚‰",
    "æŠ«è¨",
    "æ±‰å ¡/è–¯æ¡",
    "éº»è¾£çƒ«",
    "ç‚’é¥­/ç‚’é¢",
    "æ²™æ‹‰è½»é£Ÿ",
    "ä¾¿åˆ©åº—éšä¾¿",
    "å¤–å–è¯„ä»·æœ€é«˜é‚£å®¶"
  ];

  const LS_KEY = "dinner_wheel_items_v1";

  const $ = (id) => document.getElementById(id);
  const canvas = $("wheel");
  const ctx = canvas.getContext("2d");
  const spinBtn = $("spinBtn");
  const shuffleBtn = $("shuffleBtn");
  const pickNowBtn = $("pickNowBtn");
  const saveBtn = $("saveBtn");
  const resetBtn = $("resetBtn");
  const itemsArea = $("itemsArea");
  const countEl = $("count");
  const lastEl = $("last");
  const hintEl = $("hint");
  const toastEl = $("toast");

  // æ—‹è½¬çŠ¶æ€
  let items = [];
  let angle = 0;           // å½“å‰è§’åº¦ï¼ˆå¼§åº¦ï¼‰
  let angVel = 0;          // è§’é€Ÿåº¦
  let spinning = false;
  let lastPick = "â€”";

  // ====== å·¥å…· ======
  function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toastEl.classList.remove("show"), 1400);
  }

  function normalizeItems(text) {
    return text
      .split(/\r?\n/)
      .map(s => s.trim())
      .filter(Boolean);
  }

  function loadItems() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return DEFAULT_ITEMS.slice();
      const arr = JSON.parse(raw);
      if (Array.isArray(arr) && arr.length) return arr.map(String).map(s => s.trim()).filter(Boolean);
      return DEFAULT_ITEMS.slice();
    } catch {
      return DEFAULT_ITEMS.slice();
    }
  }

  function saveItems(arr) {
    localStorage.setItem(LS_KEY, JSON.stringify(arr));
  }

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function resizeForHiDPI() {
    // ç”»å¸ƒå·²ç”¨ 800x800ï¼ŒCSS æ§åˆ¶æ˜¾ç¤ºï¼›è¿™é‡Œç¡®ä¿æ–‡å­—æ¸…æ™°
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const size = 800;
    canvas.width = size * dpr;
    canvas.height = size * dpr;
    canvas.style.width = "min(420px, 86vw)";
    canvas.style.height = "auto";
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  // ç”ŸæˆæŸ”å’Œé¢œè‰²ï¼ˆHSLï¼‰
  function colorForIndex(i, n) {
    const hue = (i * (360 / n) + 220) % 360;
    return `hsl(${hue} 70% 55%)`;
  }

  function drawWheel() {
    const w = 800, h = 800;
    const cx = w / 2, cy = h / 2;
    const r = 360;

    ctx.clearRect(0, 0, w, h);

    // èƒŒæ™¯åœˆ
    ctx.save();
    ctx.translate(cx, cy);

    // å¤–åœˆé˜´å½±
    ctx.beginPath();
    ctx.arc(0, 0, r + 8, 0, Math.PI * 2);
    ctx.fillStyle = "rgba(0,0,0,0.25)";
    ctx.fill();

    const n = items.length || 1;
    const arc = (Math.PI * 2) / n;

    // æ‰‡åŒº
    for (let i = 0; i < n; i++) {
      const start = angle + i * arc;
      const end = start + arc;

      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.arc(0, 0, r, start, end);
      ctx.closePath();
      ctx.fillStyle = colorForIndex(i, n);
      ctx.fill();

      // åˆ†å‰²çº¿
      ctx.strokeStyle = "rgba(255,255,255,0.18)";
      ctx.lineWidth = 2;
      ctx.stroke();

      // æ–‡æœ¬
      const label = items[i] ?? "â€”";
      ctx.save();
      ctx.rotate(start + arc / 2);
      ctx.translate(r * 0.62, 0);
      ctx.rotate(Math.PI / 2);

      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.font = "700 28px ui-sans-serif, system-ui, -apple-system, PingFang SC, Microsoft YaHei";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

      // è‡ªåŠ¨ç¼©çŸ­
      const maxWidth = 240;
      let text = label;
      while (ctx.measureText(text).width > maxWidth && text.length > 2) {
        text = text.slice(0, -1);
      }
      if (text !== label) text = text.slice(0, -1) + "â€¦";
      ctx.fillText(text, 0, 0);

      ctx.restore();
    }

    // ä¸­å¿ƒç›–
    ctx.beginPath();
    ctx.arc(0, 0, 92, 0, Math.PI * 2);
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.fill();
    ctx.strokeStyle = "rgba(255,255,255,0.18)";
    ctx.lineWidth = 2;
    ctx.stroke();

    // ä¸­å¿ƒæ–‡å­—
    ctx.fillStyle = "rgba(255,255,255,0.92)";
    ctx.font = "800 30px ui-sans-serif, system-ui";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("ä»Šæ™šåƒå•¥", 0, -10);
    ctx.font = "650 18px ui-sans-serif, system-ui";
    ctx.fillStyle = "rgba(255,255,255,0.70)";
    ctx.fillText("è½¬å®ƒï¼", 0, 24);

    ctx.restore();
  }

  // æŒ‡é’ˆåœ¨æ­£ä¸Šæ–¹ï¼šæˆ‘ä»¬è¦ç®—â€œæŒ‡é’ˆæŒ‡å‘çš„æ‰‡åŒºâ€
  function pickIndexFromAngle() {
    const n = items.length;
    if (!n) return -1;
    const arc = (Math.PI * 2) / n;

    // æŒ‡é’ˆæ–¹å‘æ˜¯ -90Â°ï¼ˆæ­£ä¸Šæ–¹ï¼‰ï¼Œåœ¨ canvas é‡Œå¯¹åº”è§’åº¦ -Ï€/2
    // æˆ‘ä»¬è½®ç›˜æ˜¯æ•´ä½“ angle åç§»ï¼Œæ‰€ä»¥è¦æŠŠæŒ‡é’ˆæ˜ å°„å›æ‰‡åŒºç´¢å¼•
    const pointerAngle = -Math.PI / 2;

    // è®¡ç®— pointerAngle è½åœ¨è½®ç›˜åæ ‡ç³»çš„å“ªä¸ªæ‰‡åŒºï¼š
    // æ‰‡åŒº i è¦†ç›– [angle + i*arc, angle + (i+1)*arc)
    // ç­‰ä»·ï¼šæŠŠ (pointerAngle - angle) æ˜ å°„åˆ° [0,2Ï€)
    let a = pointerAngle - angle;
    a = (a % (Math.PI * 2) + Math.PI * 2) % (Math.PI * 2);
    const idx = Math.floor(a / arc);
    return idx;
  }

  function updateUI() {
    countEl.textContent = String(items.length);
    lastEl.textContent = lastPick;
    hintEl.textContent = items.length ? "å‡†å¤‡å¥½äº†ï¼Œå¼€è½¬ï¼" : "å…ˆåœ¨å³ä¾§å¡«ç‚¹å€™é€‰å§ï½";
    spinBtn.disabled = items.length < 2 || spinning;
    pickNowBtn.disabled = items.length < 1 || spinning;
    shuffleBtn.disabled = items.length < 2 || spinning;
  }

  function setItems(arr, syncText = true) {
    items = arr.slice();
    if (syncText) itemsArea.value = items.join("\n");
    angle = angle % (Math.PI * 2);
    drawWheel();
    updateUI();
  }

  // ====== åŠ¨ç”» ======
  function tick() {
    if (spinning) {
      // æ‘©æ“¦åŠ›è¡°å‡
      angVel *= 0.985;
      angle += angVel;

      // å°å¹…éšæœºæ‰°åŠ¨ï¼Œè®©åœæ­¢æ›´è‡ªç„¶
      angVel += (Math.random() - 0.5) * 0.00008;

      // åœæ­¢æ¡ä»¶
      if (Math.abs(angVel) < 0.0022) {
        spinning = false;
        angVel = 0;

        const idx = pickIndexFromAngle();
        const picked = items[idx] ?? "â€”";
        lastPick = picked;
        updateUI();
        drawWheel();

        // å¼¹çª—æç¤º
        setTimeout(() => {
          alert(`ä»Šæ™šåƒï¼š${picked}`);
        }, 50);
        showToast(`ğŸ‰ æŠ½åˆ°ï¼š${picked}`);
      }

      drawWheel();
      updateUI();
    }
    requestAnimationFrame(tick);
  }

  function startSpin() {
    if (spinning || items.length < 2) return;
    spinning = true;

    // åˆé€Ÿåº¦ï¼šç»™ä¸€ä¸ªèŒƒå›´ï¼Œä¿è¯ä¼šè½¬å¾ˆå¤šåœˆ
    const base = 0.22 + Math.random() * 0.18;
    angVel = base;

    showToast("è½¬èµ·æ¥äº†ï¼");
    updateUI();
  }

  function pickNow() {
    if (spinning || items.length < 1) return;
    const picked = items[Math.floor(Math.random() * items.length)];
    lastPick = picked;
    updateUI();
    drawWheel();
    alert(`ä»Šæ™šåƒï¼š${picked}`);
    showToast(`âœ… ç›´æ¥æŠ½åˆ°ï¼š${picked}`);
  }

  // ====== äº‹ä»¶ ======
  spinBtn.addEventListener("click", startSpin);
  pickNowBtn.addEventListener("click", pickNow);

  shuffleBtn.addEventListener("click", () => {
    if (spinning) return;
    shuffle(items);
    setItems(items, true);
    showToast("å·²æ‰“ä¹±é¡ºåº");
  });

  saveBtn.addEventListener("click", () => {
    const arr = normalizeItems(itemsArea.value);
    if (!arr.length) {
      showToast("èœå•ä¸ºç©ºï¼Œå…ˆå†™å‡ è¡Œå§");
      return;
    }
    saveItems(arr);
    setItems(arr, false);
    showToast("å·²ä¿å­˜èœå•");
  });

  resetBtn.addEventListener("click", () => {
    if (spinning) return;
    saveItems(DEFAULT_ITEMS);
    setItems(DEFAULT_ITEMS, true);
    showToast("å·²æ¢å¤é»˜è®¤");
  });

  // å¿«æ·é”®ï¼šSpace è½¬ï¼›Ctrl+S ä¿å­˜
  window.addEventListener("keydown", (e) => {
    if (e.code === "Space") {
      e.preventDefault();
      startSpin();
    }
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s") {
      e.preventDefault();
      saveBtn.click();
    }
  });

  window.addEventListener("resize", () => {
    resizeForHiDPI();
    drawWheel();
  });

  // ====== åˆå§‹åŒ– ======
  resizeForHiDPI();
  setItems(loadItems(), true);
  tick();
})();
</script>
</body>
</html>
